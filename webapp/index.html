<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>USDT Clicker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#071522;
      --bg2:#0b2337;
      --text:#e9f2ff;
      --muted:#a9c0d8;
      --accent:#2d7dff;
      --accent2:#18c6a3;
      --danger:#ff4d4d;

      --radius:18px;
      --radius2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
    }

    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: radial-gradient(1200px 600px at 50% -50%, #19486c 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg2) 0%, var(--bg1) 70%);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      touch-action: manipulation;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }

    *{ box-sizing:border-box; }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(14px + var(--safeTop)) 14px calc(78px + var(--safeBot)) 14px;
      gap:12px;
      max-width: 520px;
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      font-size:13px;
      color: var(--muted);
      user-select:none;
      max-width: 70%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lang{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .lang button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 999px;
      font-weight:800;
      font-size:12px;
    }
    .lang button.active{
      background: rgba(45,125,255,.22);
      border-color: rgba(45,125,255,.35);
    }

    .card{
      flex: 1;
      display:flex;
      min-height:0;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .screen{
      display:none;
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:14px;
    }
    .screen.active{ display:block; }

    .balanceWrap{
      text-align:center;
      padding: 16px 10px 10px;
    }
    .balanceLabel{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.18em;
    }
    .balance{
      margin-top:8px;
      font-size:48px;
      font-weight:900;
      line-height:1.0;
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:10px;
    }
    .balance span.unit{
      font-size:16px;
      color: var(--muted);
      font-weight:800;
    }

    .subline{
      margin-top:8px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .coinWrap{
      margin-top:14px;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .coin{
      width:min(280px, 76vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
      background: radial-gradient(120px 120px at 40% 35%, rgba(255,255,255,.16) 0%, transparent 60%),
                  radial-gradient(220px 220px at 60% 65%, rgba(45,125,255,.16) 0%, transparent 60%),
                  rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .coin:active{ transform: scale(0.995); }

    .coinInner{
      width:62%;
      aspect-ratio: 1/1;
      border-radius: 22px;
      display:flex;
      justify-content:center;
      align-items:center;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.10);
    }

    .coinInner img{
      width: 78%;
      height: 78%;
      object-fit: contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
      pointer-events:none;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }

    .stat{
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:10px 12px;
    }

    .stat .k{
      color: var(--muted);
      font-size:12px;
    }
    .stat .v{
      margin-top:6px;
      font-size:22px;
      font-weight:900;
    }
    .stat .v small{
      font-size:12px;
      color: var(--muted);
      margin-left:6px;
    }

    .hint{
      margin-top:10px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:10px 12px;
      color: var(--muted);
      font-size:13px;
    }
    .hint b{ color: var(--text); }

    .plus{
      position:absolute;
      transform: translate(-50%, -50%);
      font-weight:900;
      font-size:18px;
      color: #dff6ff;
      text-shadow: 0 6px 20px rgba(0,0,0,.55);
      animation: floatUp 900ms ease-out forwards;
      pointer-events:none;
    }
    @keyframes floatUp{
      0%   { opacity:0; transform: translate(-50%,-30%) scale(.95); }
      20%  { opacity:1; }
      100% { opacity:0; transform: translate(-50%,-110%) scale(1.06); }
    }

    .tabs{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + var(--safeBot)) 12px;
      background: linear-gradient(180deg, rgba(6,14,22,0) 0%, rgba(6,14,22,.92) 100%);
      backdrop-filter: blur(10px);
    }
    .tabsInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }

    .tabBtn{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding:12px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      color: var(--text);
      border-color: rgba(45,125,255,.35);
      background: rgba(45,125,255,.18);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .box{
      flex:1;
      min-width:170px;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size:13px;
      color: var(--muted);
    }
    .bigNum{
      font-size:30px;
      font-weight:900;
    }

    .field{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    input, select{
      flex:1;
      min-width:0;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:14px;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 16px;
      background: rgba(45,125,255,.25);
      color: var(--text);
      font-weight:900;
      border:1px solid rgba(45,125,255,.35);
      cursor:pointer;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .btn.ok{
      background: rgba(24,198,163,.18);
      border-color: rgba(24,198,163,.28);
    }
    .btn.danger{
      background: rgba(255,77,77,.14);
      border-color: rgba(255,77,77,.22);
    }

    .pkgGrid{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .pkg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:14px;
    }
    .pkgTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .pkgName{
      font-weight:900;
      font-size:17px;
    }
    .pkgPrice{
      font-weight:900;
      font-size:17px;
      color:#dff6ff;
      white-space:nowrap;
    }
    .pkgMeta{
      margin-top:6px;
      color: var(--muted);
      font-size:13px;
    }

    .withdrawBox{
      margin-top:20px;
      padding:16px;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
    }
    .withdrawBox h3{
      margin:0 0 12px;
      font-size:15px;
      color:var(--text);
    }

    .withdraw-status{
      margin-top:12px;
      padding:10px;
      border-radius:12px;
      background: rgba(24,198,163,.08);
      border:1px solid rgba(24,198,163,.20);
      font-size:13px;
      color:#a0f0d0;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="pill">üë§ <span id="userName">‚Äî</span></div>
      <div class="lang">
        <button id="btnRU" class="active">RU</button>
        <button id="btnEN">EN</button>
      </div>
    </div>

    <div class="card">

      <!-- TAP / HOME -->
      <div class="screen active" id="screenHome">
        <div class="balanceWrap">
          <div class="balanceLabel" data-i18n="balance_label">–ë–ê–õ–ê–ù–°</div>
          <div class="balance">
            <div id="balanceVal">0.0000</div>
            <span class="unit">USDT</span>
          </div>
          <div class="subline" id="planLine"></div>
        </div>

        <div class="coinWrap">
          <div class="coin" id="coin">
            <div class="coinInner">
              <img id="logoImg" src="/static/logo.png?v=2" alt="USDT" />
            </div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k" data-i18n="taps_left">–û–°–¢–ê–õ–û–°–¨ –¢–ê–ü–û–í</div>
            <div class="v"><span id="tapsLeft">‚Äî</span></div>
          </div>
          <div class="stat">
            <div class="k" data-i18n="reward">–ù–ê–ì–†–ê–î–ê</div>
            <div class="v">+<span id="rewardVal">0.0000</span> <small>USDT</small></div>
          </div>
        </div>

        <div class="hint" id="hintBox"></div>
      </div>

      <!-- INVITE -->
      <div class="screen" id="screenInvite">
        <div class="balanceWrap" style="padding-top:6px">
          <div class="balanceLabel" data-i18n="invite_title">–ü–†–ò–ì–õ–ê–°–ò–¢–¨</div>
          <div class="subline" data-i18n="invite_sub">
            –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π +0.1 USDT –∑–∞ –∫–∞–∂–¥–æ–≥–æ.
          </div>
          <div class="subline" data-i18n="invite_sub2">
            –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ 10 000 —Ç–∞–ø–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ 1 USDT.
          </div>
        </div>

        <div class="row">
          <div class="box">
            <h3 data-i18n="invited_count">–ü–†–ò–ì–õ–ê–®–ï–ù–û</h3>
            <div class="bigNum"><span id="invitedCount">0</span></div>
          </div>
          <div class="box">
            <h3 data-i18n="invite_bonus">–ë–û–ù–£–°</h3>
            <div class="bigNum">+<span id="inviteBonusTotal">0.0000</span> <span class="muted">USDT</span></div>
          </div>
        </div>

        <div class="subCard">
          <h3 data-i18n="your_link">–¢–í–û–Ø –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–°–´–õ–ö–ê</h3>
          <div class="field">
            <input id="refLink" readonly />
            <button class="btn" id="copyRef" data-i18n="copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="subCard">
          <h3 data-i18n="ref_list">–†–ï–§–ï–†–ê–õ–´</h3>
          <div class="list" id="refList"></div>
        </div>
      </div>

      <!-- ACCOUNT / CABINET -->
      <div class="screen" id="screenCabinet">
        <div class="balanceWrap" style="padding-top:6px">
          <div class="balanceLabel" data-i18n="account_title">–ê–ö–ö–ê–£–ù–¢</div>
        </div>

        <div class="subCard">
          <h3 data-i18n="account_balance">–ë–ê–õ–ê–ù–°</h3>
          <div class="bigNum"><span id="cabBalance">0.0000</span> <span class="muted">USDT</span></div>
        </div>

        <!-- –ü–ê–ö–ï–¢–´ —Ç–µ–ø–µ—Ä—å –∑–¥–µ—Å—å -->
        <div class="subCard">
          <h3 data-i18n="packages_title">–ü–ê–ö–ï–¢–´</h3>
          <div class="subline" data-i18n="packages_sub">
            –í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–∞–ø–∞—Ç—å –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
          </div>
          <div class="pkgGrid" id="pkgGrid"></div>

          <!-- –ø–∞–Ω–µ–ª—å –æ–ø–ª–∞—Ç—ã (—Ç–∞ –∂–µ, —á—Ç–æ –±—ã–ª–∞ —Ä–∞–Ω—å—à–µ) -->
          <div id="payPanel" style="display:none; margin-top:16px;">
            <div class="subCard">
              <h3 data-i18n="payment_title">–û–ü–õ–ê–¢–ê</h3>
              <div class="subline" id="payInfoLine"></div>
              <div class="field">
                <input id="payAddress" class="mono" readonly />
                <button class="btn ghost" id="copyAddressBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
              <div class="field">
                <input id="payAmount" class="mono" readonly />
                <button class="btn ghost" id="copyAmountBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
              <div class="field" style="margin-top:12px;">
                <button class="btn ok" id="checkPayBtn" data-i18n="check_payment">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
                <button class="btn danger" id="closePayBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
              <div class="subline" style="margin-top:12px; font-size:12px;">
                <span class="muted">‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª—è–π —Ç–æ—á–Ω—É—é —Å—É–º–º—É —Å –∫–æ–ø–µ–π–∫–∞–º–∏</span>
              </div>
            </div>
          </div>
        </div>

        <!-- –í–´–í–û–î –°–†–ï–î–°–¢–í -->
        <div class="withdrawBox" id="withdrawSection">
          <h3>–í–´–í–û–î –°–†–ï–î–°–¢–í</h3>
          
          <div class="field">
            <input type="number" id="withdrawAmount" placeholder="–°—É–º–º–∞ (–º–∏–Ω. 20 USDT)" step="0.01" min="20" />
          </div>

          <div class="field" style="margin-top:10px;">
            <select id="withdrawNetwork">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å</option>
              <option value="TRC20">TRC20 (Tron)</option>
              <option value="BEP20">BEP20 (BSC)</option>
              <option value="TON">TON</option>
            </select>
          </div>

          <div class="field" style="margin-top:10px;">
            <input type="text" id="withdrawAddress" placeholder="–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞" />
          </div>

          <button class="btn ok" id="btnWithdraw" style="margin-top:14px; width:100%;">
            –í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
          </button>

          <div id="withdrawStatus" class="withdraw-status" style="display:none;"></div>
        </div>

        <!-- –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ) -->
        <div class="subCard" style="margin-top:16px; font-size:12px;">
          userId: <b id="srvUserId">‚Äî</b><br>
          taps left: <b id="srvTapsLeft">‚Äî</b><br>
          tap reward: <b id="srvReward">‚Äî</b>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tabsInner">
      <button class="tabBtn" id="tabInvite" data-i18n="tab_invite">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
      <button class="tabBtn active" id="tabHome" data-i18n="tab_home">TAP</button>
      <button class="tabBtn" id="tabCabinet" data-i18n="tab_account">–ê–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </div>

  <script>
    // ========================================
    //   –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ‚Äî –í–ê–ñ–ù–û!
    // ========================================
    const BOT_USERNAME = "hfufh4fu4bot";           // ‚Üê —Ç–≤–æ–π –±–æ—Ç
    const ADMIN_TG_ID   = 123456789;               // ‚Üê –¢–í–û–ô Telegram ID !!!!!!!!

    // ========================================
    //   –ü–ï–†–ï–í–û–î–´
    // ========================================
    const I18N = {
      ru: {
        balance_label: "–ë–ê–õ–ê–ù–°",
        taps_left: "–¢–ê–ü–û–í –û–°–¢–ê–õ–û–°–¨",
        reward: "–ù–ê–ì–†–ê–î–ê –ó–ê –¢–ê–ü",
        tab_invite: "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å",
        tab_home: "TAP",
        tab_account: "–ê–∫–∫–∞—É–Ω—Ç",
        invite_title: "–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô",
        invite_sub: "–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π +0.1 USDT –∑–∞ –∫–∞–∂–¥–æ–≥–æ",
        invite_sub2: "–ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ 10 000 —Ç–∞–ø–æ–≤ –∏ 1 USDT –∑–∞—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞",
        invited_count: "–ü–†–ò–ì–õ–ê–®–ï–ù–û",
        invite_bonus: "–ë–û–ù–£–°",
        your_link: "–¢–í–û–Ø –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–°–´–õ–ö–ê",
        copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
        ref_list: "–†–ï–§–ï–†–ê–õ–´",
        account_title: "–ê–ö–ö–ê–£–ù–¢",
        account_balance: "–ë–ê–õ–ê–ù–°",
        packages_title: "–ü–ê–ö–ï–¢–´",
        packages_sub: "–í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–∞–ø–∞—Ç—å",
        buy: "–ö—É–ø–∏—Ç—å",
        payment_title: "–û–ü–õ–ê–¢–ê",
        copy_address: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å",
        copy_amount: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—É–º–º—É",
        check_payment: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É",
        close: "–ó–∞–∫—Ä—ã—Ç—å",
        payment_note: "–û—Ç–ø—Ä–∞–≤–ª—è–π –¢–û–ß–ù–£–Æ —Å—É–º–º—É (—Å –∫–æ–ø–µ–π–∫–∞–º–∏)",
        pay_created: "–°–æ–∑–¥–∞–Ω –∏–Ω–≤–æ–π—Å. –ü–µ—Ä–µ–≤–µ–¥–∏ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É ‚Üì",
        paid_ok: "–û–ø–ª–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚úì –ü–∞–∫–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω",
        not_paid: "–ü–æ–∫–∞ –Ω–µ –≤–∏–¥–Ω–æ. –ü–æ–¥–æ–∂–¥–∏ 1‚Äì5 –º–∏–Ω—É—Ç",
        server_error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
        no_refs: "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç",
        hint: () => `üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞</b><br>–ß–µ–ª–æ–≤–µ–∫ –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –∏ –Ω–∞–∂–∞—Ç—å Start`
      },
      en: {
        balance_label: "BALANCE",
        taps_left: "TAPS LEFT",
        reward: "REWARD PER TAP",
        tab_invite: "Invite",
        tab_home: "TAP",
        tab_account: "Account",
        invite_title: "INVITE FRIENDS",
        invite_sub: "Invite friends and get +0.1 USDT each",
        invite_sub2: "Bonus credited after referral reaches 10,000 taps and 1 USDT earned",
        invited_count: "INVITED",
        invite_bonus: "BONUS",
        your_link: "YOUR REFERRAL LINK",
        copy: "Copy",
        ref_list: "REFERRALS",
        account_title: "ACCOUNT",
        account_balance: "BALANCE",
        packages_title: "PACKAGES",
        packages_sub: "Choose a package to continue tapping",
        buy: "Buy",
        payment_title: "PAYMENT",
        copy_address: "Copy address",
        copy_amount: "Copy amount",
        check_payment: "Check payment",
        close: "Close",
        payment_note: "Send EXACT amount (with decimals)",
        pay_created: "Invoice created. Send the exact amount below",
        paid_ok: "Payment detected ‚úì Package activated",
        not_paid: "Not seen yet. Wait a few minutes",
        server_error: "Server error",
        no_refs: "No referrals yet",
        hint: () => `üéÅ <b>Referral via bot</b><br>User must open link and press Start`
      }
    };

    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    // ========================================
    //   –°–û–°–¢–û–Ø–ù–ò–ï
    // ========================================
    const state = {
      lang: "ru",
      userId: null,
      fullName: "User",

      balance: 0,
      tapsLeft: 0,
      tapsTotal: 0,
      tapReward: 0,
      capRemaining: 0,

      referrals: [],
      invitedCount: 0,
      bonusTotal: 0,

      packages: null,
      payAddress: "",
      currentInvoice: null,

      isTapping: false,
      tapCooldownUntil: 0,

      // –¥–ª—è –≤—ã–≤–æ–¥–∞
      withdrawInProgress: false
    };

    function fmt(x, decimals = 4) {
      if (!Number.isFinite(x)) return "0.0000";
      return Number(x).toFixed(decimals);
    }

    function escapeHtml(s) {
      return String(s||"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c]));
    }

    function detectLang() {
      const code = (tg?.initDataUnsafe?.user?.language_code || "").toLowerCase();
      return code.startsWith("en") ? "en" : "ru";
    }

    function initUser() {
      const u = tg?.initDataUnsafe?.user;
      if (u) {
        state.userId = u.id;
        const name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim();
        state.fullName = name || (u.username ? `@${u.username}` : "User");
      } else {
        state.userId = 999999;
        state.fullName = "Test User";
      }
      document.getElementById("userName").textContent = state.fullName;
      state.lang = detectLang();
    }

    async function apiPost(path, body = {}) {
      try {
        const r = await fetch(path, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({...body, lang: state.lang})
        });
        const text = await r.text();
        if (!r.ok) throw new Error(text);
        return JSON.parse(text);
      } catch (err) {
        console.error(path, err);
        return {ok:false, error: err.message};
      }
    }

    async function apiGet(path) {
      try {
        const r = await fetch(path);
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      } catch (err) {
        console.error(path, err);
        return {ok:false};
      }
    }

    function getRefLink() {
      return state.userId ? `https://t.me/${BOT_USERNAME}?start=ref_${state.userId}` : "";
    }

    function showToast(msg, title = "") {
      if (tg?.showPopup) {
        tg.showPopup({title: title || " ", message: msg, buttons:[{type:"ok"}]});
      } else {
        alert((title ? title + "\n" : "") + msg);
      }
    }

    async function copyText(txt) {
      try {
        await navigator.clipboard.writeText(txt);
        return true;
      } catch {
        return false;
      }
    }

    // ========================================
    //   UI ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
    // ========================================
    function showScreen(name) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));

      document.getElementById(`screen${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add("active");
      document.getElementById(`tab${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add("active");
    }

    document.getElementById("tabHome").onclick    = () => showScreen("home");
    document.getElementById("tabInvite").onclick  = () => showScreen("invite");
    document.getElementById("tabCabinet").onclick = () => showScreen("cabinet");

    // ========================================
    //   –†–µ–Ω–¥–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ (—Ç–µ–ø–µ—Ä—å –≤ Account)
    // ========================================
    function renderPackages() {
      const grid = document.getElementById("pkgGrid");
      if (!state.packages) {
        grid.innerHTML = '<div style="color:var(--muted);padding:12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        return;
      }

      grid.innerHTML = "";
      const order = ["1","2","3"]; // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 3 –ø–∞–∫–µ—Ç–∞

      order.forEach(key => {
        const p = state.packages[key];
        if (!p) return;

        let emoji = "üü¢";
        let name = p.name || `–ü–∞–∫–µ—Ç ${key}`;

        if (key === "1") { emoji = "üë∂"; name = "–ù–æ–≤–∏—á–æ–∫"; }
        if (key === "2") { emoji = "‚≠ê"; name = "–ü—Ä–æ—Ñ–∏";   }
        if (key === "3") { emoji = "üê≥"; name = "–ö–∏—Ç";     }

        const div = document.createElement("div");
        div.className = "pkg";
        div.innerHTML = `
          <div class="pkgTop">
            <div>
              <div class="pkgName">${emoji} ${name}</div>
              <div class="pkgMeta">
                —Ç–∞–ø–æ–≤: <b>${Number(p.taps||0).toLocaleString()}</b><br>
                –Ω–∞–≥—Ä–∞–¥–∞: <b>${fmt(p.reward||0,4)}</b> USDT / —Ç–∞–ø<br>
                –º–∞–∫—Å. –ø—Ä–æ—Ñ–∏—Ç: <b>${fmt(p.cap||0,2)}</b> USDT
              </div>
            </div>
            <div class="pkgPrice">${fmt(p.price||0,2)} USDT</div>
          </div>
          <button class="btn ok" data-pkg-id="${key}" style="margin-top:12px;width:100%;">
            ${I18N[state.lang].buy}
          </button>
        `;
        grid.appendChild(div);
      });

      grid.querySelectorAll("[data-pkg-id]").forEach(btn => {
        btn.onclick = () => createInvoice(btn.dataset.pkgId);
      });
    }

    // ========================================
    //   –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
    // ========================================
    const payPanel   = document.getElementById("payPanel");
    const payInfo    = document.getElementById("payInfoLine");
    const payAddr    = document.getElementById("payAddress");
    const payAmnt    = document.getElementById("payAmount");

    function openPayment(invoice) {
      state.currentInvoice = invoice;
      payInfo.textContent = I18N[state.lang].pay_created;
      payAddr.value  = invoice.address  || "";
      payAmnt.value  = fmt(invoice.amount_usdt || 0, 6);
      payPanel.style.display = "block";
      payPanel.scrollIntoView({behavior:"smooth"});
    }

    document.getElementById("closePayBtn").onclick = () => {
      payPanel.style.display = "none";
      state.currentInvoice = null;
    };

    document.getElementById("copyAddressBtn").onclick = async () => {
      const ok = await copyText(payAddr.value);
      showToast(ok ? "–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω" : "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
    };

    document.getElementById("copyAmountBtn").onclick = async () => {
      const ok = await copyText(payAmnt.value);
      showToast(ok ? "–°—É–º–º–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞" : "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
    };

    async function createInvoice(pkgId) {
      const res = await apiPost("/api/payments/create", { tg_id: state.userId, package_id: pkgId });
      if (res?.ok && res.invoice) {
        openPayment(res.invoice);
      } else {
        showToast(res?.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å");
      }
    }

    document.getElementById("checkPayBtn").onclick = async () => {
      if (!state.currentInvoice?.id) return;
      const res = await apiPost("/api/payments/check", {
        tg_id: state.userId,
        invoice_id: state.currentInvoice.id
      });
      if (res?.ok) {
        if (res.paid) {
          showToast(I18N[state.lang].paid_ok);
          payPanel.style.display = "none";
          syncWithServer();
        } else {
          showToast(I18N[state.lang].not_paid);
        }
      } else {
        showToast("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏");
      }
    };

    // ========================================
    //   –í–´–í–û–î –°–†–ï–î–°–¢–í
    // ========================================
    document.getElementById("btnWithdraw").onclick = async () => {
      if (state.withdrawInProgress) return;

      const amt  = Number(document.getElementById("withdrawAmount").value);
      const net  = document.getElementById("withdrawNetwork").value;
      const addr = document.getElementById("withdrawAddress").value.trim();

      if (amt < 20) {
        showToast("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 20 USDT");
        return;
      }
      if (!net) {
        showToast("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å");
        return;
      }
      if (!addr || addr.length < 10) {
        showToast("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å");
        return;
      }

      state.withdrawInProgress = true;
      const btn = document.getElementById("btnWithdraw");
      btn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
      btn.disabled = true;

      try {
        const res = await apiPost("/api/withdraw/create", {
          tg_id: state.userId,
          amount: amt,
          network: net,
          address: addr,
          full_name: state.fullName
        });

        if (res.ok) {
          document.getElementById("withdrawStatus").innerHTML =
            `‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞<br>–°—É–º–º–∞: ${fmt(amt,2)} USDT<br>–°–µ—Ç—å: ${net}<br>–û–±—Ä–∞–±–æ—Ç–∫–∞: –¥–æ 24 —á–∞—Å–æ–≤`;
          document.getElementById("withdrawStatus").style.display = "block";

          showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞\n–û–∂–∏–¥–∞–π—Ç–µ –¥–æ 24 —á–∞—Å–æ–≤");
        } else {
          showToast(res.error || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏");
        }
      } catch (err) {
        showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
      } finally {
        state.withdrawInProgress = false;
        btn.textContent = "–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞";
        btn.disabled = false;
      }
    };

    // ========================================
    //   TAP –ª–æ–≥–∏–∫–∞ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 0 —Ç–∞–ø–æ–≤
    // ========================================
    const coin = document.getElementById("coin");

    function spawnPlus(x, y, text) {
      const el = document.createElement("div");
      el.className = "plus";
      el.style.left = x + "px";
      el.style.top  = y + "px";
      el.textContent = text;
      coin.appendChild(el);
      setTimeout(()=>el.remove(), 900);
    }

    function tapXY(e) {
      const r = coin.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    async function handleTap(e) {
      e.preventDefault();
      if (Date.now() < state.tapCooldownUntil) return;
      state.tapCooldownUntil = Date.now() + 120;

      const {x,y} = tapXY(e);

      if (state.tapsLeft <= 0 || state.tapReward <= 0) {
        spawnPlus(x, y, "+0.0000");
        showToast("–¢–∞–ø—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å", "–ö—É–ø–∏ –ø–∞–∫–µ—Ç ‚Üí –ê–∫–∫–∞—É–Ω—Ç");
        return;
      }

      spawnPlus(x, y, "+" + fmt(state.tapReward, 4));

      if (state.isTapping) return;
      state.isTapping = true;

      try {
        const res = await apiPost("/api/tap", { tg_id: state.userId });
        if (res.ok) {
          Object.assign(state, {
            balance:     Number(res.balance_usdt || state.balance),
            tapsLeft:    Number(res.taps_available || 0),
            tapsTotal:   Number(res.taps_total || state.tapsTotal),
            tapReward:   Number(res.tap_reward || state.tapReward),
            capRemaining:Number(res.earn_cap_remaining || 0)
          });
          renderHome();
        }
      } finally {
        state.isTapping = false;
      }
    }

    coin.addEventListener("pointerdown", handleTap);
    coin.addEventListener("touchstart", handleTap, {passive:false});

    // ========================================
    //   –†–µ–Ω–¥–µ—Ä –¥–æ–º–∞—à–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
    // ========================================
    function renderHome() {
      document.getElementById("balanceVal").textContent = fmt(state.balance, state.balance < 1 ? 4 : 2);
      document.getElementById("tapsLeft").textContent   = state.tapsLeft || "‚Äî";
      document.getElementById("rewardVal").textContent  = fmt(state.tapReward || 0, 4);

      const r = Number(state.tapReward || 0);
      document.getElementById("planLine").textContent = r > 0
        ? `+${fmt(r,4)} USDT / —Ç–∞–ø`
        : (state.lang === "ru" ? "–ö—É–ø–∏ –ø–∞–∫–µ—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ –ê–∫–∫–∞—É–Ω—Ç" : "Buy package in Account");

      document.getElementById("hintBox").innerHTML = I18N[state.lang].hint();
    }

    function renderInvite() {
      document.getElementById("refLink").value = getRefLink();
      document.getElementById("invitedCount").textContent = state.invitedCount || 0;
      document.getElementById("inviteBonusTotal").textContent = fmt(state.bonusTotal || 0, 4);

      const list = document.getElementById("refList");
      list.innerHTML = "";

      if (!state.referrals?.length) {
        list.innerHTML = `<div class="item muted">${I18N[state.lang].no_refs}</div>`;
        return;
      }

      state.referrals.forEach(r => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<span>${escapeHtml(r.name||"")}</span><span>+${fmt(r.reward_usdt||0,2)} USDT</span>`;
        list.appendChild(div);
      });
    }

    function setLanguage(lng) {
      state.lang = lng;
      document.getElementById("btnRU").classList.toggle("active", lng==="ru");
      document.getElementById("btnEN").classList.toggle("active", lng==="en");

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        if (I18N[lng][k]) el.textContent = I18N[lng][k];
      });

      renderHome();
      renderInvite();
      renderPackages();
    }

    document.getElementById("btnRU").onclick = () => setLanguage("ru");
    document.getElementById("btnEN").onclick = () => setLanguage("en");

    // ========================================
    //   –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    // ========================================
    async function syncWithServer() {
      // –ø–∞–∫–µ—Ç—ã
      const pkgs = await apiGet("/api/packages");
      if (pkgs?.ok) {
        state.packages = pkgs.packages || {};
        renderPackages();
      }

      // –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const me = await apiGet(`/api/user/${state.userId}`);
      if (me?.ok) {
        Object.assign(state, {
          balance:     Number(me.balance?.balance_usdt || 0),
          tapsLeft:    Number(me.taps?.taps_available || 0),
          tapsTotal:   Number(me.taps?.taps_total || 0),
          tapReward:   Number(me.taps?.tap_reward || 0),
          capRemaining:Number(me.taps?.earn_cap_remaining || 0)
        });

        document.getElementById("cabBalance").textContent = fmt(state.balance, 4);
        document.getElementById("srvUserId").textContent  = state.userId;
        document.getElementById("srvTapsLeft").textContent= state.tapsLeft;
        document.getElementById("srvReward").textContent  = fmt(state.tapReward,4);

        renderHome();
      }

      // —Ä–µ—Ñ–µ—Ä–∞–ª—ã
      const refs = await apiGet(`/api/referrals/${state.userId}`);
      if (refs?.ok) {
        state.referrals    = refs.referrals || [];
        state.invitedCount = Number(refs.invited_count || 0);
        state.bonusTotal   = Number(refs.bonus_total || 0);
        renderInvite();
      }
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ-—Å—Å—ã–ª–∫—É
    document.getElementById("copyRef").onclick = async () => {
      const link = getRefLink();
      const ok = await copyText(link);
      showToast(ok ? "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!" : "–û—à–∏–±–∫–∞");
    };

    // ========================================
    //   –°–¢–ê–†–¢
    // ========================================
    (function init() {
      initUser();
      setLanguage(state.lang);
      showScreen("home");
      syncWithServer();
      // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 30‚Äì60 —Å–µ–∫
      // setInterval(syncWithServer, 45000);
    })();
  </script>
</body>
</html>