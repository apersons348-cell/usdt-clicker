<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>USDT Clicker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#071522;
      --bg2:#0b2337;
      --text:#e9f2ff;
      --muted:#a9c0d8;
      --accent:#2d7dff;
      --accent2:#18c6a3;
      --danger:#ff4d4d;

      --radius:18px;
      --radius2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
    }

    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: radial-gradient(1200px 600px at 50% -50%, #19486c 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg2) 0%, var(--bg1) 70%);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      touch-action: manipulation;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }

    *{ box-sizing:border-box; }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(14px + var(--safeTop)) 14px calc(78px + var(--safeBot)) 14px;
      gap:12px;
      max-width: 520px;
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      font-size:13px;
      color: var(--muted);
      user-select:none;
      -webkit-user-select:none;
      max-width: 70%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lang{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .lang button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 999px;
      font-weight:800;
      font-size:12px;
      touch-action: manipulation;
    }
    .lang button.active{
      background: rgba(45,125,255,.22);
      border-color: rgba(45,125,255,.35);
    }

    .card{
      flex: 1;
      display:flex;
      min-height:0;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .screen{
      display:none;
      flex:1;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      padding:14px;
      touch-action: pan-y;
    }
    .screen.active{ display:block; }

    .balanceWrap{
      text-align:center;
      padding: 16px 10px 10px;
    }
    .balanceLabel{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.18em;
    }
    .balance{
      margin-top:8px;
      font-size:48px;
      font-weight:900;
      line-height:1.0;
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:10px;
    }
    .balance span.unit{
      font-size:16px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.08em;
    }

    .subline{
      margin-top:8px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .coinWrap{
      margin-top:14px;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .coin{
      width:min(280px, 76vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;

      background:
        radial-gradient(120px 120px at 40% 35%, rgba(255,255,255,.16) 0%, transparent 60%),
        radial-gradient(220px 220px at 60% 65%, rgba(45,125,255,.16) 0%, transparent 60%),
        rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);

      -webkit-user-select:none;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;

      touch-action: none;
    }
    .coin:active{ transform: scale(0.995); }

    .coinInner{
      width:62%;
      aspect-ratio: 1/1;
      border-radius: 22px;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.10);
    }

    .coinInner img{
      width: 78%;
      height: 78%;
      object-fit: contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }

    .stat{
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:10px 12px;
    }

    .stat .k{
      color: var(--muted);
      font-size:12px;
      letter-spacing:.12em;
    }
    .stat .v{
      margin-top:6px;
      font-size:22px;
      font-weight:900;
    }
    .stat .v small{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      margin-left:6px;
    }

    .hint{
      margin-top:10px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:10px 12px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
      text-align:left;
    }
    .hint b{ color: var(--text); }

    .plus{
      position:absolute;
      transform: translate(-50%, -50%);
      font-weight:900;
      font-size:18px;
      color: #dff6ff;
      text-shadow: 0 6px 20px rgba(0,0,0,.55);
      animation: floatUp 900ms ease-out forwards;
      pointer-events:none;
      user-select:none;
    }
    @keyframes floatUp{
      0%   { opacity:0; transform: translate(-50%,-30%) scale(.95); }
      20%  { opacity:1; }
      100% { opacity:0; transform: translate(-50%,-110%) scale(1.06); }
    }

    .tabs{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px calc(10px + var(--safeBot)) 12px;
      background: linear-gradient(180deg, rgba(6,14,22,0) 0%, rgba(6,14,22,.70) 25%, rgba(6,14,22,.92) 100%);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      touch-action: manipulation;
    }
    .tabsInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }

    .tabBtn{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding:12px 12px;
      border-radius: 16px;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .tabBtn.active{
      color: var(--text);
      border-color: rgba(45,125,255,.35);
      background: rgba(45,125,255,.18);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .box{
      flex:1;
      min-width: 170px;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      padding:12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size:13px;
      color: var(--muted);
      letter-spacing:.12em;
    }
    .bigNum{
      font-size:30px;
      font-weight:900;
    }

    .field{
      display:flex;
      gap:8px;
      margin-top:10px;
      touch-action: manipulation;
      flex-wrap:wrap;
    }

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size:14px;
      touch-action: manipulation;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 12px;
      background: rgba(45,125,255,.25);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      border:1px solid rgba(45,125,255,.35);
      touch-action: manipulation;
      width:100%;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      width:auto;
      white-space:nowrap;
      padding:12px 14px;
    }
    .btn.ok{
      background: rgba(24,198,163,.18);
      border-color: rgba(24,198,163,.28);
    }
    .btn.danger{
      background: rgba(255,77,77,.14);
      border-color: rgba(255,77,77,.22);
    }

    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 320px;
      overflow:auto;
      padding-right:4px;
      touch-action: pan-y;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      font-size:14px;
      align-items:center;
    }
    .muted{ color: var(--muted); }

    .subCard{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding:12px;
      touch-action: manipulation;
    }
    .subCard h3{
      margin:0 0 8px;
      font-size:13px;
      color: var(--muted);
      letter-spacing:.12em;
    }

    .pkgGrid{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    .pkg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:12px;
    }
    .pkgTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .pkgName{
      font-weight:900;
      font-size:16px;
    }
    .pkgPrice{
      font-weight:900;
      font-size:16px;
      color:#dff6ff;
      white-space:nowrap;
    }
    .pkgMeta{
      margin-top:6px;
      color: var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .pkgActions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .pkgActions .btn{
      width:auto;
      flex:1;
      min-width: 140px;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="pill">üë§ <span id="userName">‚Äî</span></div>
      <div class="lang">
        <button id="btnRU" class="active">RU</button>
        <button id="btnEN">EN</button>
      </div>
    </div>

    <div class="card">
      <!-- HOME -->
      <div class="screen active" id="screenHome">
        <div class="balanceWrap">
          <div class="balanceLabel" data-i18n="balance_label">BALANCE</div>
          <div class="balance">
            <div id="balanceVal">0.0000</div>
            <span class="unit">USDT</span>
          </div>
          <div class="subline" id="planLine"></div>
        </div>

        <div class="coinWrap">
          <div class="coin" id="coin">
            <div class="coinInner" id="coinInner">
              <img id="logoImg" src="/static/logo.png" alt="USDT" />
            </div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k" data-i18n="taps_left">TAPS LEFT</div>
            <div class="v"><span id="tapsLeft">‚Äî</span></div>
          </div>
          <div class="stat">
            <div class="k" data-i18n="reward">REWARD</div>
            <div class="v">+<span id="rewardVal">0.0000</span> <small>USDT</small></div>
          </div>
        </div>

        <div class="hint" id="hintBox"></div>

        <!-- PACKAGES -->
        <div class="subCard" id="shopCard">
          <h3 data-i18n="packages_title">PACKAGES</h3>
          <div class="subline" data-i18n="packages_sub">
            Buy a package to get taps and higher reward.
          </div>

          <div class="pkgGrid" id="pkgGrid"></div>

          <!-- PAYMENT PANEL -->
          <div class="subCard" id="payPanel" style="display:none; margin-top:12px;">
            <h3 data-i18n="payment_title">PAYMENT</h3>
            <div class="subline" id="payInfoLine"></div>

            <div class="field">
              <input id="payAddress" class="mono" readonly />
              <button class="btn ghost" id="copyAddressBtn" data-i18n="copy_address">Copy address</button>
            </div>

            <div class="field">
              <input id="payAmount" class="mono" readonly />
              <button class="btn ghost" id="copyAmountBtn" data-i18n="copy_amount">Copy amount</button>
            </div>

            <div class="field">
              <button class="btn ok" id="checkPayBtn" data-i18n="check_payment">Check payment</button>
              <button class="btn danger" id="closePayBtn" data-i18n="close">Close</button>
            </div>

            <div class="subline" style="margin-top:8px">
              <span class="muted" data-i18n="payment_note">
                IMPORTANT: send the exact amount (10.xxxxxx). The server matches payment by amount.
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- INVITE -->
      <div class="screen" id="screenInvite">
        <div class="balanceWrap" style="padding-top:6px">
          <div class="balanceLabel" data-i18n="invite_title">INVITE</div>
          <div class="subline" data-i18n="invite_sub">
            Invite friends and earn 0.1 USDT for each friend.
          </div>
          <div class="subline" data-i18n="invite_sub2">
            0.1 USDT is credited after your referral makes 10,000 clicks and earns 1 USDT.
          </div>
        </div>

        <div class="row">
          <div class="box">
            <h3 data-i18n="invited_count">INVITED</h3>
            <div class="bigNum"><span id="invitedCount">0</span></div>
          </div>
          <div class="box">
            <h3 data-i18n="invite_bonus">BONUS</h3>
            <div class="bigNum">+<span id="inviteBonusTotal">0.0000</span> <span class="muted">USDT</span></div>
          </div>
        </div>

        <div class="subCard">
          <h3 data-i18n="your_link">YOUR REFERRAL LINK</h3>
          <div class="field">
            <input id="refLink" readonly />
            <button class="btn" id="copyRef" data-i18n="copy">Copy</button>
          </div>
          <div class="subline" style="margin-top:8px">
            <span class="muted">–í–∞–∂–Ω–æ:</span> —Å—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –≤ –±–æ—Ç–∞ (—á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª /start –∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞).
          </div>
        </div>

        <div class="subCard">
          <h3 data-i18n="ref_list">REFERRALS</h3>
          <div class="list" id="refList"></div>
        </div>
      </div>

      <!-- CABINET -->
      <div class="screen" id="screenCabinet">
        <div class="balanceWrap" style="padding-top:6px">
          <div class="balanceLabel" data-i18n="account_title">ACCOUNT</div>
          <div class="subline" data-i18n="account_sub">Server data</div>
        </div>

        <div class="subCard" style="margin-top:0;">
          <h3 data-i18n="account_balance">YOUR BALANCE</h3>
          <div class="bigNum"><span id="cabBalance">0.0000</span> <span class="muted">USDT</span></div>
        </div>

        <div class="subCard">
          <h3>SERVER</h3>
          <div class="subline" id="serverLine">
            userId: <b id="srvUserId">‚Äî</b><br>
            status: <b id="srvStatus">‚Äî</b>
          </div>
        </div>

        <div class="subCard">
          <h3 data-i18n="tap_stats">TAP STATS</h3>
          <div class="subline" id="tapStatsLine">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="tabsInner">
      <button class="tabBtn" id="tabInvite" data-i18n="tab_invite">Invite</button>
      <button class="tabBtn active" id="tabHome" data-i18n="tab_home">TAP</button>
      <button class="tabBtn" id="tabCabinet" data-i18n="tab_account">Account</button>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const BOT_USERNAME = "hfufh4fu4bot"; // –±–µ–∑ @

    // =========================
    // I18N
    // =========================
    const I18N = {
      ru: {
        balance_label: "–ë–ê–õ–ê–ù–°",
        taps_left: "–û–°–¢–ê–õ–û–°–¨ –¢–ê–ü–û–í",
        reward: "–ù–ê–ì–†–ê–î–ê",
        tab_invite: "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å",
        tab_home: "TAP",     // ‚úÖ –æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü–µ–π
        tab_account: "–ê–∫–∫–∞—É–Ω—Ç",
        invite_title: "–ü–†–ò–ì–õ–ê–°–ò–¢–¨",
        invite_sub: "–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π 0.1 USDT –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞.",
        invite_sub2: "0.1 USDT –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª —Å–¥–µ–ª–∞–µ—Ç 10,000 —Ç–∞–ø–æ–≤ –∏ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç 1 USDT.",
        invited_count: "–ü–†–ò–ì–õ–ê–®–ï–ù–û",
        invite_bonus: "–ë–û–ù–£–°",
        your_link: "–¢–í–û–Ø –†–ï–§-–°–´–õ–ö–ê",
        copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
        ref_list: "–†–ï–§–ï–†–ê–õ–´",
        account_title: "–ê–ö–ö–ê–£–ù–¢",
        account_sub: "–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞",
        account_balance: "–¢–í–û–ô –ë–ê–õ–ê–ù–°",
        no_refs: "–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–∏—à—ë–ª",
        packages_title: "–ü–ê–ö–ï–¢–´",
        packages_sub: "–ö—É–ø–∏ –ø–∞–∫–µ—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–∞–ø—ã –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É.",
        buy: "–ö—É–ø–∏—Ç—å",
        payment_title: "–û–ü–õ–ê–¢–ê",
        copy_address: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å",
        copy_amount: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—É–º–º—É",
        check_payment: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É",
        close: "–ó–∞–∫—Ä—ã—Ç—å",
        payment_note: "–í–ê–ñ–ù–û: –ø–µ—Ä–µ–≤–æ–¥–∏ —Ç–æ—á–Ω—É—é —Å—É–º–º—É (10.xxxxxx). –°–µ—Ä–≤–µ—Ä –Ω–∞–π–¥—ë—Ç –ø–ª–∞—Ç—ë–∂ –ø–æ —Å—É–º–º–µ.",
        pay_created: "–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ–≤–µ–¥–∏ —Å—É–º–º—É –Ω–∞ –∞–¥—Ä–µ—Å –Ω–∏–∂–µ.",
        paid_ok: "–û–ø–ª–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚úÖ –ü–∞–∫–µ—Ç –≤—ã–¥–∞–Ω.",
        not_paid: "–ü–ª–∞—Ç—ë–∂ –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–∑–∂–µ.",
        server_error: "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
        tap_stats: "–°–¢–ê–¢–ò–°–¢–ò–ö–ê TAP",
        hint: () => `üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞:</b><br><span class="muted">–ß–µ–ª–æ–≤–µ–∫ –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –∏ –Ω–∞–∂–∞—Ç—å Start.</span>`
      },
      en: {
        balance_label: "BALANCE",
        taps_left: "TAPS LEFT",
        reward: "REWARD",
        tab_invite: "Invite",
        tab_home: "TAP",     // ‚úÖ –æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü–µ–π
        tab_account: "Account",
        invite_title: "INVITE",
        invite_sub: "Invite friends and earn 0.1 USDT for each invited friend.",
        invite_sub2: "0.1 USDT is credited after referral makes 10,000 taps and earns 1 USDT.",
        invited_count: "INVITED",
        invite_bonus: "BONUS",
        your_link: "YOUR REF LINK",
        copy: "Copy",
        ref_list: "REFERRALS",
        account_title: "ACCOUNT",
        account_sub: "Server data",
        account_balance: "YOUR BALANCE",
        no_refs: "No one joined yet",
        packages_title: "PACKAGES",
        packages_sub: "Buy a package to get taps and higher reward.",
        buy: "Buy",
        payment_title: "PAYMENT",
        copy_address: "Copy address",
        copy_amount: "Copy amount",
        check_payment: "Check payment",
        close: "Close",
        payment_note: "IMPORTANT: send the exact amount (10.xxxxxx). The server matches payment by amount.",
        pay_created: "Invoice created. Send the amount to the address below.",
        paid_ok: "Payment found ‚úÖ Package granted.",
        not_paid: "Payment not found yet. Check again later.",
        server_error: "Server error",
        tap_stats: "TAP STATS",
        hint: () => `üéÅ <b>Referral works via bot:</b><br><span class="muted">User must open link and press Start.</span>`
      }
    };

    // =========================
    // Telegram init
    // =========================
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    function detectLang(){
      const tgLang = (tg?.initDataUnsafe?.user?.language_code || "").toLowerCase();
      if (tgLang.startsWith("en")) return "en";
      return "ru";
    }

    // =========================
    // State
    // =========================
    const state = {
      lang: "ru",
      userId: null,
      fullName: "User",

      balance: 0,

      tapsLeft: 0,
      tapsTotal: 0,
      tapReward: 0,
      capRemaining: 0,

      referrals: [],
      invitedCount: 0,
      bonusTotal: 0,

      packages: null,   // { "1":{...}, ... }
      payAddress: "",
      payNetwork: "",
      currentInvoice: null, // {id, amount_usdt, address, ...}
      isTapping: false,
      tapCooldownUntil: 0
    };

    function fmtBalance(x){
      x = Number(x || 0);
      if (!Number.isFinite(x)) x = 0;
      if (x < 1) return x.toFixed(4);
      if (x < 100) return x.toFixed(3);
      return x.toFixed(2);
    }

    function fmtReward(x){
      x = Number(x || 0);
      if (!Number.isFinite(x)) x = 0;
      if (x < 1) return x.toFixed(4);
      return x.toFixed(3);
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#039;"
      }[c]));
    }

    function initFromTelegram(){
      const u = tg?.initDataUnsafe?.user;
      if (u){
        state.userId = u.id;
        const first = (u.first_name || "").trim();
        const last  = (u.last_name || "").trim();
        state.fullName = (first + " " + last).trim() || (u.username ? `@${u.username}` : "User");
      } else {
        state.userId = 999001;
        state.fullName = "Browser User";
      }
      document.getElementById("userName").textContent = state.fullName;
      state.lang = detectLang();
    }

    async function apiPost(path, payload){
      const resp = await fetch(path, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload || {})
      });
      const text = await resp.text();
      if (!resp.ok) throw new Error(text);
      try { return JSON.parse(text); } catch(e){ return {}; }
    }

    async function apiGet(path){
      const resp = await fetch(path);
      const text = await resp.text();
      if (!resp.ok) throw new Error(text);
      try { return JSON.parse(text); } catch(e){ return {}; }
    }

    function getRefLink(){
      if (!state.userId) return "";
      return `https://t.me/${BOT_USERNAME}?start=ref_${state.userId}`;
    }

    function showToast(title, message){
      if (tg?.showPopup){
        tg.showPopup({
          title: title || "Info",
          message: message || "",
          buttons: [{type:"ok"}]
        });
        return;
      }
      alert((title ? title + "\n" : "") + (message || ""));
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        return false;
      }
    }

    // =========================
    // UI: screens
    // =========================
    const screenHome = document.getElementById("screenHome");
    const screenInvite = document.getElementById("screenInvite");
    const screenCabinet = document.getElementById("screenCabinet");

    const tabInvite = document.getElementById("tabInvite");
    const tabHome = document.getElementById("tabHome");
    const tabCabinet = document.getElementById("tabCabinet");

    function showScreen(name){
      screenHome.classList.toggle("active", name === "home");
      screenInvite.classList.toggle("active", name === "invite");
      screenCabinet.classList.toggle("active", name === "cabinet");

      tabInvite.classList.toggle("active", name === "invite");
      tabHome.classList.toggle("active", name === "home");
      tabCabinet.classList.toggle("active", name === "cabinet");
    }

    tabInvite.addEventListener("click", () => showScreen("invite"));
    tabHome.addEventListener("click", () => showScreen("home"));
    tabCabinet.addEventListener("click", () => showScreen("cabinet"));

    // =========================
    // Render
    // =========================
    function renderHome(){
      document.getElementById("balanceVal").textContent = fmtBalance(state.balance);

      document.getElementById("tapsLeft").textContent =
        Number.isFinite(Number(state.tapsLeft)) ? String(state.tapsLeft) : "‚Äî";

      document.getElementById("rewardVal").textContent = fmtReward(state.tapReward || 0);

      const r = Number(state.tapReward || 0);
      document.getElementById("planLine").textContent = r > 0
        ? `+${fmtReward(r)} USDT / TAP`
        : (state.lang === "ru" ? "–ö—É–ø–∏ –ø–∞–∫–µ—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å" : "Buy a package to start");

      document.getElementById("hintBox").innerHTML = I18N[state.lang].hint();

      renderPackages();
    }

    function renderInvite(){
      const input = document.getElementById("refLink");
      input.value = getRefLink();

      document.getElementById("invitedCount").textContent = String(state.invitedCount || 0);
      document.getElementById("inviteBonusTotal").textContent = Number(state.bonusTotal || 0).toFixed(4);

      const list = document.getElementById("refList");
      list.innerHTML = "";

      if (!state.referrals || !state.referrals.length){
        const empty = document.createElement("div");
        empty.className = "item";
        empty.innerHTML = `<span class="muted">${I18N[state.lang].no_refs}</span><span class="muted">‚Äî</span>`;
        list.appendChild(empty);
        return;
      }

      state.referrals.forEach((r)=>{
        const name = (r.name || "User").toString();
        const reward = Number(r.reward_usdt || 0).toFixed(2);
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `<span>${escapeHtml(name)}</span><span class="muted">+${reward} USDT</span>`;
        list.appendChild(it);
      });
    }

    function renderCabinet(statusText){
      document.getElementById("cabBalance").textContent = fmtBalance(state.balance);
      document.getElementById("srvUserId").textContent = String(state.userId || "‚Äî");
      document.getElementById("srvStatus").textContent = statusText || "ok";

      const line = document.getElementById("tapStatsLine");
      line.innerHTML =
        `taps_total: <b>${state.tapsTotal ?? "‚Äî"}</b><br>` +
        `taps_left: <b>${state.tapsLeft ?? "‚Äî"}</b><br>` +
        `tap_reward: <b>${fmtReward(state.tapReward || 0)}</b><br>` +
        `cap_remaining: <b>${fmtBalance(state.capRemaining || 0)}</b>`;
    }

    function setLang(lang){
      state.lang = lang;

      document.getElementById("btnRU").classList.toggle("active", lang==="ru");
      document.getElementById("btnEN").classList.toggle("active", lang==="en");

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        const val = I18N[lang][key];
        if (typeof val === "string") el.textContent = val;
      });

      renderHome();
      renderInvite();
      renderCabinet("ok");
    }

    document.getElementById("btnRU").addEventListener("click", ()=>setLang("ru"));
    document.getElementById("btnEN").addEventListener("click", ()=>setLang("en"));

    // =========================
    // PACKAGES + PAYMENT
    // =========================
    const pkgGrid = document.getElementById("pkgGrid");
    const payPanel = document.getElementById("payPanel");
    const payInfoLine = document.getElementById("payInfoLine");
    const payAddressInput = document.getElementById("payAddress");
    const payAmountInput = document.getElementById("payAmount");
    const copyAddressBtn = document.getElementById("copyAddressBtn");
    const copyAmountBtn = document.getElementById("copyAmountBtn");
    const checkPayBtn = document.getElementById("checkPayBtn");
    const closePayBtn = document.getElementById("closePayBtn");

    function renderPackages(){
      if (!state.packages){
        pkgGrid.innerHTML = `<div class="item"><span class="muted">Loading‚Ä¶</span><span class="muted">‚Äî</span></div>`;
        return;
      }

      // state.packages ‚Äî –æ–±—ä–µ–∫—Ç –≤–∏–¥–∞ {"1":{...},"2":{...}}
      const keys = Object.keys(state.packages).sort((a,b)=>Number(a)-Number(b));
      pkgGrid.innerHTML = "";

      keys.forEach((k)=>{
        const p = state.packages[k];
        const id = Number(k);

        const name = p?.name ?? `Package ${id}`;
        const price = Number(p?.price ?? 0);
        const taps = Number(p?.taps ?? 0);
        const reward = Number(p?.reward ?? 0);
        const cap = Number(p?.cap ?? 0);

        const wrap = document.createElement("div");
        wrap.className = "pkg";

        wrap.innerHTML = `
          <div class="pkgTop">
            <div>
              <div class="pkgName">${escapeHtml(name)}</div>
              <div class="pkgMeta">
                taps: <b>${taps.toLocaleString()}</b><br>
                reward: <b>${fmtReward(reward)}</b> USDT / TAP<br>
                max profit: <b>${fmtBalance(cap)}</b> USDT
              </div>
            </div>
            <div class="pkgPrice">${fmtBalance(price)} USDT</div>
          </div>
          <div class="pkgActions">
            <button class="btn ok" data-buy-id="${id}">${I18N[state.lang].buy}</button>
          </div>
        `;

        pkgGrid.appendChild(wrap);
      });

      pkgGrid.querySelectorAll("[data-buy-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.getAttribute("data-buy-id"));
          await createInvoice(id);
        });
      });
    }

    function openPayPanel(invoice){
      state.currentInvoice = invoice;

      payPanel.style.display = "block";
      payInfoLine.textContent = I18N[state.lang].pay_created;

      payAddressInput.value = invoice.address || state.payAddress || "";
      payAmountInput.value = String(invoice.amount_usdt ?? "");

      // small scroll to panel
      payPanel.scrollIntoView({behavior:"smooth", block:"start"});
    }

    function closePayPanel(){
      state.currentInvoice = null;
      payPanel.style.display = "none";
    }

    closePayBtn.addEventListener("click", closePayPanel);

    copyAddressBtn.addEventListener("click", async ()=>{
      const ok = await copyText(payAddressInput.value);
      showToast(ok ? "OK" : "Copy", ok ? "Address copied ‚úÖ" : "Copy failed");
    });

    copyAmountBtn.addEventListener("click", async ()=>{
      const ok = await copyText(payAmountInput.value);
      showToast(ok ? "OK" : "Copy", ok ? "Amount copied ‚úÖ" : "Copy failed");
    });

    async function createInvoice(packageId){
      if (!state.userId){
        showToast("Error", "No userId");
        return;
      }
      try{
        const res = await apiPost("/api/payments/create", {
          tg_id: state.userId,
          package_id: packageId
        });

        if (res && res.ok && res.invoice){
          openPayPanel(res.invoice);
        } else {
          showToast("Error", "Bad response");
        }
      }catch(e){
        showToast("Error", I18N[state.lang].server_error);
        console.log(e);
      }
    }

    checkPayBtn.addEventListener("click", async ()=>{
      if (!state.currentInvoice?.id){
        showToast("Error", "No invoice");
        return;
      }
      try{
        const res = await apiPost("/api/payments/check", {
          tg_id: state.userId,
          invoice_id: state.currentInvoice.id
        });

        if (res && res.ok){
          if (res.paid){
            showToast("OK", I18N[state.lang].paid_ok);
            closePayPanel();
            await syncWithServer(); // –ø–æ–¥—Ç—è–Ω–µ–º –Ω–æ–≤—ã–µ taps/reward
            showScreen("home");
          } else {
            showToast("Info", I18N[state.lang].not_paid);
          }
        } else {
          showToast("Error", I18N[state.lang].server_error);
        }
      }catch(e){
        showToast("Error", I18N[state.lang].server_error);
        console.log(e);
      }
    });

    // =========================
    // Server sync
    // =========================
    async function syncWithServer(){
      // 0) packages
      try{
        const p = await apiGet("/api/packages");
        if (p && p.ok){
          state.packages = p.packages || null;
          state.payAddress = p.address || "";
          state.payNetwork = p.network || "";
        }
      }catch(e){
        // ignore
      }

      // 1) upsert —Å–µ–±—è
      try{
        await apiPost("/api/user/upsert", { tg_id: state.userId });
      }catch(e){
        console.log("upsert failed:", e);
      }

      // 2) user data
      try{
        const me = await apiGet(`/api/user/${state.userId}`);
        if (me && me.ok){
          state.balance = Number(me.balance?.balance_usdt || 0);

          state.tapsLeft = Number(me.taps?.taps_available ?? 0);
          state.tapsTotal = Number(me.taps?.taps_total ?? 0);
          state.tapReward = Number(me.taps?.tap_reward ?? 0);
          state.capRemaining = Number(me.taps?.earn_cap_remaining ?? 0);

          renderHome();
          renderCabinet("ok");
        } else {
          renderCabinet("user not found");
        }
      }catch(e){
        console.log("get user failed:", e);
        renderCabinet("server error");
      }

      // 3) referrals (–µ—Å–ª–∏ endpoint –µ—Å—Ç—å ‚Äî –æ—Ç–ª–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–∏—à–∏–Ω–∞)
      try{
        const r = await apiGet(`/api/referrals/${state.userId}`);
        if (r && r.ok){
          state.referrals = Array.isArray(r.referrals) ? r.referrals : [];
          state.invitedCount = Number(r.invited_count || 0);
          state.bonusTotal = Number(r.bonus_total || 0);
          renderInvite();
        }
      }catch(e){
        // ignore
      }
    }

    // =========================
    // Copy link button
    // =========================
    document.getElementById("copyRef").addEventListener("click", async ()=>{
      const link = getRefLink();
      const input = document.getElementById("refLink");
      input.value = link;

      let ok = await copyText(link);
      if (!ok){
        input.select();
        try { document.execCommand("copy"); ok = true; } catch(e){}
      }

      showToast(state.lang === "ru" ? "–ì–æ—Ç–æ–≤–æ" : "Done", ok ? "‚úÖ" : "‚ùå");
    });

    // =========================
    // Tap logic (REAL TAP)
    // =========================
    const coin = document.getElementById("coin");

    function spawnPlusText(x, y, text){
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.style.left = x + "px";
      plus.style.top = y + "px";
      plus.textContent = text;
      coin.appendChild(plus);
      setTimeout(()=>plus.remove(), 900);
    }

    function getLocalXY(e){
      const rect = coin.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    async function doTap(e){
      e.preventDefault();

      const now = Date.now();
      if (now < state.tapCooldownUntil) return;
      state.tapCooldownUntil = now + 120;

      const {x,y} = getLocalXY(e);

      // –µ—Å–ª–∏ taps –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
      if ((state.tapsLeft ?? 0) <= 0 || (state.tapReward ?? 0) <= 0 || (state.capRemaining ?? 0) <= 0){
        spawnPlusText(x, y, "+0.0000");
        return;
      }

      // –ª–æ–∫–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å—Ä–∞–∑—É
      spawnPlusText(x, y, "+" + fmtReward(state.tapReward || 0));

      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      if (state.isTapping) return;
      state.isTapping = true;

      try{
        const res = await apiPost("/api/tap", { tg_id: state.userId, taps: 1 });
        if (res && res.ok){
          state.balance = Number(res.balance_usdt ?? state.balance ?? 0);
          state.tapsLeft = Number(res.taps_available ?? state.tapsLeft ?? 0);
          state.tapsTotal = Number(res.taps_total ?? state.tapsTotal ?? 0);
          state.tapReward = Number(res.tap_reward ?? state.tapReward ?? 0);
          state.capRemaining = Number(res.earn_cap_remaining ?? state.capRemaining ?? 0);

          renderHome();
          renderCabinet("ok");
        }
      }catch(err){
        console.log(err);
      }finally{
        state.isTapping = false;
      }
    }

    coin.addEventListener("pointerdown", doTap);
    coin.addEventListener("touchstart", doTap, { passive:false });

    // =========================
    // Logo cache bust
    // =========================
    const logoImg = document.getElementById("logoImg");
    logoImg.src = `/static/logo.png?v=${Date.now()}`;
    logoImg.addEventListener("error", ()=>{
      const inner = document.getElementById("coinInner");
      inner.innerHTML = `<div style="font-weight:900; letter-spacing:.08em; color:#dff6ff">USDT</div>`;
    });

    // =========================
    // BOOT
    // =========================
    (function boot(){
      initFromTelegram();
      setLang(state.lang);
      showScreen("home");
      syncWithServer();
    })();
  </script>
</body>
</html>
